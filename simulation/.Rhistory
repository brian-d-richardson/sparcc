B0
# oracle
B0 <- get.root(dat = dat0, score = get.Scc,
start = c(naive.lm$coef, log(var(naive.lm$resid))))
# complete case
Bcc <- get.root(dat = dat, score = get.Scc,
start = c(naive.lm$coef, log(var(naive.lm$resid))))
# MLE
Bmle <- get.root(dat = dat, score = get.Sml, start = Bcc,
args = list(mu = mu, d.mu = d.mu, SF = SF, fy = fy,
x.nds = x.nds, x.wts = x.wts))
Bmle
# semiparametric efficient score
Beff <- get.root(dat = dat, score = get.Seff, start = Bcc,
args = list(mu = mu, d.mu = d.mu, SF = SF, fy = fy,
eta1 = eta1,
x.nds = x.nds, x.wts = x.wts,
c.nds = c.nds, c.wts = c.wts,
y.nds = y.nds, y.wts = y.wts))
Beff
rm(list = ls())
library(dplyr)
library(tidyverse)
library(ggplot2)
library(ggh4x)
library(scales)
library(ggthemes)
library(kableExtra)
# true (beta, log s2)
B <- c(1, 2, log(1.1))
# load simulation results from each of 10 clusters
sim.out.list <- lapply(
X = 0:9,
FUN = function(clust) {
cbind(clust,
read.csv(paste0("sim_data/sim1/estetas_meanX2_shape_1_5/sd",
clust, ".csv")))
})
# combine simulation results into 1 data frame
sim.out <- bind_rows(sim.out.list)
colnames(sim.out) <- c("clust", "n", "q", "x.shape", "c.shape",
"mx", "mc", "my", "seed",
"Bor1", "Bor2", "Bor3",
"Bcc1", "Bcc2", "Bcc3",
"Bml1", "Bml2", "Bml3",
"Bsp1", "Bsp2", "Bsp3")
# make long data frame
sim.out.long <- sim.out %>%
pivot_longer(cols = starts_with("B"),
names_to = "method.param",
values_to = "estimate") %>%
mutate(method = factor(substr(method.param, 2, 3),
levels = c("or", "cc", "ml", "sp")),
param = factor(substr(method.param, 4, 4)),
B.true = B[param])
# check for simulations with errors
sim.out.long %>%
filter(param == 1) %>%
group_by(q, n, x.shape, c.shape, method) %>%
summarize(prop.error = mean(is.na(estimate))) %>%
filter(prop.error > 0) %>%
kable(digits = 3) %>%
kable_styling("striped")
# extract simulation parameters
q <- unique(sim.out$q)
n <- unique(sim.out$n)
x.shape <- unique(sim.out$x.shape)
c.shape <- unique(sim.out$c.shape)
mx <- unique(sim.out$mx)
mc <- unique(sim.out$mc)
my <- unique(sim.out$my)
n.rep <- nrow(sim.out) /
n_distinct(dplyr::select(sim.out, q, n, x.shape, c.shape, mx, mc, my))
# make labels for plots
method.labs <- c("Oracle",
"Complete Case",
"Parametric MLE",
"Semiparametric")
names(method.labs) <- c("or", "cc", "ml", "sp")
q.labs <- paste0("q = ", q)
names(q.labs) <- q
n.labs <- paste0("n = ", n)
names(n.labs) <- n
shapex.labs <- c("X Correct", "X Incorrect")
names(shapex.labs) <- x.shape
shapec.labs <- c("C Correct", "C Incorrect")
names(shapec.labs) <- c.shape
mx.labs <- paste0("mx = ", mx)
names(mx.labs) <- mx
mc.labs <- paste0("mc = ", mc)
names(mc.labs) <- mc
my.labs <- paste0("my = ", my)
names(my.labs) <- my
param.labs <- c("\u03B20", "\u03B21", "log\u03C3\u00B2")
# colorblind friendly pallette
#pal_light <- cbbPalette <- c('#BBBBBB', '#228833', '#4477AA', '#AA3377')
#pal_dark <- cbbPalette <- c('#5d5d5d', '#114419', '#223b55', '#55193b')
pal_light <- c('#EE6677', '#228833', '#4477AA', '#CCBB44', '#66CCEE', '#AA3377', '#BBBBBB')
pal_dark <- c('#991122', '#114419', '#223b55', '#6b611d', '#117799', '#55193b', '#5d5d5d')
# boxplot of simulated estimates
make.est.plot <- function(param., n. = 10000, est_cutoff = Inf) {
# data for plot
plot.dat <- sim.out.long %>%
filter(param == param.,
n == n.) %>%
mutate(remove = abs(estimate - B.true) > est_cutoff,
lab.y = 0.5*(B.true - est_cutoff))
# count removed observations
remove.dat <- plot.dat %>%
group_by(q, method, x.shape, c.shape, lab.y, B.true) %>%
summarise(n.remove = sum(remove, na.rm = T)) %>%
mutate(label = ifelse(n.remove > 0,
paste0(n.remove, "\n",
method.labs[method],
"\npoints outside\nrange"), ""),
lab.y = ifelse(n.remove > 0, lab.y, B.true))
plot.dat %>%
filter(remove == F) %>%
ggplot(aes(y = estimate,
color = method,
fill = method)) +
geom_boxplot() +
geom_text(data = remove.dat,
aes(x = -0.15, y = lab.y, label = label),
size = 2, color = "black") +
geom_hline(aes(yintercept = B.true),
linetype = "dashed",
linewidth = 0.6,
color = pal_light[4]) +
facet_nested(q ~ x.shape + c.shape,
scales = "free",
labeller = labeller(q = q.labs,
x.shape = shapex.labs,
c.shape = shapec.labs)) +
labs(y = "Parameter Estimate",
fill = "Method",
color = "Method") +
ggtitle(paste0("Empirical Distribution of Parameter Estimates for ",
param.labs[param.]),
subtitle = paste0("sample size n = ", n., "; ",
"mx = ", mx, "; ",
"mc = ", mc, "; ",
"my = ", my, "; ",
n.rep, " replicates per setting")) +
theme_bw() +
theme(axis.ticks.x = element_blank(),
axis.text.x = element_blank(),
axis.title.x = element_blank()) +
scale_fill_manual(values = pal_light[c(1, 2, 3, 6)],
labels = method.labs) +
scale_color_manual(values = pal_dark[c(1, 2, 3, 6)],
labels = method.labs)
}
make.est.plot(param. = 1, n. = 10000)
make.est.plot(param. = 2, n. = 10000)
make.est.plot(param. = 3, n. = 10000)
make.est.plot(param. = 1, n. = 10000)
make.est.plot(param. = 2, n. = 10000)
make.est.plot(param. = 3, n. = 10000)
make.est.plot(param. = 1, n. = 10000, est_cutoff = 1)
make.est.plot(param. = 1, n. = 10000, est_cutoff = 1)
make.est.plot(param. = 2, n. = 10000, est_cutoff = 1)
make.est.plot(param. = 2, n. = 10000, est_cutoff = 0.7)
make.est.plot(param. = 3, n. = 10000, est_cutoff = 0.2)
make.est.plot(param. = 1, n. = 10000, est_cutoff = 1)
make.est.plot(param. = 2, n. = 10000, est_cutoff = 0.7)
make.est.plot(param. = 3, n. = 10000, est_cutoff = 0.2)
make.est.plot(param. = 1, n. = 10000, est_cutoff = 1)
make.est.plot(param. = 2, n. = 10000, est_cutoff = 0.7)
make.est.plot(param. = 3, n. = 10000, est_cutoff = 0.2)
make.est.plot(param. = 1, n. = 10000, est_cutoff = 1)
make.est.plot(param. = 2, n. = 10000, est_cutoff = 0.5)
make.est.plot(param. = 3, n. = 10000, est_cutoff = 0.2)
tbl <- sim.out.long %>%
group_by(q, x.shape, c.shape, method, param) %>%
summarise(bias = 100*mean(estimate - B.true, na.rm = T),
emp.se = 100*sd(estimate, na.rm = T),
mse = 100*mean((estimate - B.true) ^ 2, na.rm = T)) %>%
gather(key, value, bias:mse) %>%
unite(Group, param, key) %>%
spread(Group, value)
setNames(tbl, sub(".+_", "", names(tbl))) %>%
kable(digits = 2) %>%
kable_styling("striped") %>%
add_header_above(c(" " = 4,
"beta_0" = 3,
"beta_1" = 3,
"log(var)" = 3))
setNames(tbl, sub(".+_", "", names(tbl))) %>%
kable(digits = 2) %>%
kable_styling("striped") %>%
add_header_above(c(" " = 4,
"beta_0" = 3,
"beta_1" = 3,
"log(var)" = 3))
rm(list = ls())
#setwd(dirname(getwd()))
library(ggplot2)
library(devtools)
load_all()
# define parameters -------------------------------------------------------
n <- 10000            # sample size
q <- 0.8              # censoring proportion
B <- c(1, 2)          # beta
s2 <- 1.1             # variance of Y|X,Z
x.mean <- 4           # mean of X
assess.dat(n = n, q = q, B = B, s2 = s2, x.mean = x.mean,
x.shape = 1, c.shape = 1)
assess.dat(n = n, q = q, B = B, s2 = s2, x.mean = x.mean,
x.shape = 1, c.shape = 1.25)
assess.dat(n = n, q = q, B = B, s2 = s2, x.mean = x.mean,
x.shape = 1.25, c.shape = 1)
assess.dat(n = n, q = q, B = B, s2 = s2, x.mean = x.mean,
x.shape = 1.25, c.shape = 1.25)
assess.dat(n = n, q = q, B = B, s2 = s2, x.mean = x.mean,
x.shape = 1, c.shape = 2)
assess.dat(n = n, q = q, B = B, s2 = s2, x.mean = x.mean,
x.shape = 1, c.shape = 1.25)
rm(list = ls())
library(dplyr)
library(tidyverse)
library(ggplot2)
library(ggh4x)
library(scales)
library(ggthemes)
library(kableExtra)
# true (beta, log s2)
B <- c(1, 2, log(1.1))
# load simulation results from each of 10 clusters
sim.out.list <- lapply(
X = 0:9,
FUN = function(clust) {
cbind(clust,
read.csv(paste0("sim_data/sim1/estetas_meanX0_25_shape0_25/sd",
clust, ".csv")))
})
# combine simulation results into 1 data frame
sim.out <- bind_rows(sim.out.list)
colnames(sim.out) <- c("clust", "n", "q", "x.shape", "c.shape",
"mx", "mc", "my", "seed",
"Bor1", "Bor2", "Bor3",
"Bcc1", "Bcc2", "Bcc3",
"Bml1", "Bml2", "Bml3",
"Bsp1", "Bsp2", "Bsp3")
# make long data frame
sim.out.long <- sim.out %>%
pivot_longer(cols = starts_with("B"),
names_to = "method.param",
values_to = "estimate") %>%
mutate(method = factor(substr(method.param, 2, 3),
levels = c("or", "cc", "ml", "sp")),
param = factor(substr(method.param, 4, 4)),
B.true = B[param])
# check for simulations with errors
sim.out.long %>%
filter(param == 1) %>%
group_by(q, n, x.shape, c.shape, method) %>%
summarize(prop.error = mean(is.na(estimate))) %>%
filter(prop.error > 0) %>%
kable(digits = 3) %>%
kable_styling("striped")
# extract simulation parameters
q <- unique(sim.out$q)
n <- unique(sim.out$n)
x.shape <- unique(sim.out$x.shape)
c.shape <- unique(sim.out$c.shape)
mx <- unique(sim.out$mx)
mc <- unique(sim.out$mc)
my <- unique(sim.out$my)
n.rep <- nrow(sim.out) /
n_distinct(dplyr::select(sim.out, q, n, x.shape, c.shape, mx, mc, my))
# make labels for plots
method.labs <- c("Oracle",
"Complete Case",
"Parametric MLE",
"Semiparametric")
names(method.labs) <- c("or", "cc", "ml", "sp")
q.labs <- paste0("q = ", q)
names(q.labs) <- q
n.labs <- paste0("n = ", n)
names(n.labs) <- n
shapex.labs <- c("X Correct", "X Incorrect")
names(shapex.labs) <- x.shape
shapec.labs <- c("C Correct", "C Incorrect")
names(shapec.labs) <- c.shape
mx.labs <- paste0("mx = ", mx)
names(mx.labs) <- mx
mc.labs <- paste0("mc = ", mc)
names(mc.labs) <- mc
my.labs <- paste0("my = ", my)
names(my.labs) <- my
param.labs <- c("\u03B20", "\u03B21", "log\u03C3\u00B2")
# colorblind friendly pallette
#pal_light <- cbbPalette <- c('#BBBBBB', '#228833', '#4477AA', '#AA3377')
#pal_dark <- cbbPalette <- c('#5d5d5d', '#114419', '#223b55', '#55193b')
pal_light <- c('#EE6677', '#228833', '#4477AA', '#CCBB44', '#66CCEE', '#AA3377', '#BBBBBB')
pal_dark <- c('#991122', '#114419', '#223b55', '#6b611d', '#117799', '#55193b', '#5d5d5d')
# boxplot of simulated estimates
make.est.plot <- function(param., n. = 10000, est_cutoff = Inf) {
# data for plot
plot.dat <- sim.out.long %>%
filter(param == param.,
n == n.) %>%
mutate(remove = abs(estimate - B.true) > est_cutoff,
lab.y = 0.5*(B.true - est_cutoff))
# count removed observations
remove.dat <- plot.dat %>%
group_by(q, method, x.shape, c.shape, lab.y, B.true) %>%
summarise(n.remove = sum(remove, na.rm = T)) %>%
mutate(label = ifelse(n.remove > 0,
paste0(n.remove, "\n",
method.labs[method],
"\npoints outside\nrange"), ""),
lab.y = ifelse(n.remove > 0, lab.y, B.true))
# create plot
plot.dat %>%
filter(remove == F) %>%
ggplot(aes(y = estimate,
color = method,
fill = method)) +
geom_boxplot() +
geom_text(data = remove.dat,
aes(x = -0.15, y = lab.y, label = label),
size = 2, color = "black") +
geom_hline(aes(yintercept = B.true),
linetype = "dashed",
linewidth = 0.6,
color = pal_light[4]) +
facet_nested(q ~ x.shape + c.shape,
scales = "free",
labeller = labeller(q = q.labs,
x.shape = shapex.labs,
c.shape = shapec.labs)) +
labs(y = "Parameter Estimate",
fill = "Method",
color = "Method") +
ggtitle(paste0("Empirical Distribution of Parameter Estimates for ",
param.labs[param.]),
subtitle = paste0("sample size n = ", n., "; ",
"mx = ", mx, "; ",
"mc = ", mc, "; ",
"my = ", my, "; ",
n.rep, " replicates per setting")) +
theme_bw() +
theme(axis.ticks.x = element_blank(),
axis.text.x = element_blank(),
axis.title.x = element_blank()) +
scale_fill_manual(values = pal_light[c(1, 2, 3, 6)],
labels = method.labs) +
scale_color_manual(values = pal_dark[c(1, 2, 3, 6)],
labels = method.labs)
}
make.est.plot(param. = 1, n. = 10000)
make.est.plot(param. = 2, n. = 10000)
make.est.plot(param. = 3, n. = 10000)
make.est.plot(param. = 1, n. = 10000, est_cutoff = 1)
make.est.plot(param. = 1, n. = 10000, est_cutoff = 0.5)
make.est.plot(param. = 2, n. = 10000, est_cutoff = 0.5)
make.est.plot(param. = 1, n. = 10000)
make.est.plot(param. = 1, n. = 10000) + ylim(0, 4)
make.est.plot(param. = 1, n. = 10000) + ylim(0.9, 1.2)
make.est.plot(param. = 2, n. = 10000)
make.est.plot(param. = 2, n. = 10000) + ylim(0, 4)
make.est.plot(param. = 2, n. = 10000) + ylim(-2, 6)
make.est.plot(param. = 2, n. = 10000) + ylim(0, 4)
make.est.plot(param. = 3, n. = 10000)
make.est.plot(param. = 3, n. = 10000) + ylim(-0.4, -0.05)
make.est.plot(param. = 3, n. = 10000)
make.est.plot(param. = 3, n. = 10000) + ylim(0, 0.2)
make.est.plot(param. = 1, n. = 10000) + ylim(0.9, 1.2)
make.est.plot(param. = 2, n. = 10000) + ylim(0, 4)
make.est.plot(param. = 3, n. = 10000) + ylim(0, 0.2)
rm(list = ls())
library(dplyr)
library(tidyverse)
library(ggplot2)
library(ggh4x)
library(scales)
library(ggthemes)
library(kableExtra)
# true (beta, log s2)
B <- c(1, 2, log(1.1))
# load simulation results from each of 10 clusters
sim.out.list <- lapply(
X = 0:9,
FUN = function(clust) {
cbind(clust,
read.csv(paste0("sim_data/sim1/estetas_meanX0_25_shape0_25/sd",
clust, ".csv")))
})
# combine simulation results into 1 data frame
sim.out <- bind_rows(sim.out.list)
colnames(sim.out) <- c("clust", "n", "q", "x.shape", "c.shape",
"mx", "mc", "my", "seed",
"Bor1", "Bor2", "Bor3",
"Bcc1", "Bcc2", "Bcc3",
"Bml1", "Bml2", "Bml3",
"Bsp1", "Bsp2", "Bsp3")
# make long data frame
sim.out.long <- sim.out %>%
pivot_longer(cols = starts_with("B"),
names_to = "method.param",
values_to = "estimate") %>%
mutate(method = factor(substr(method.param, 2, 3),
levels = c("or", "cc", "ml", "sp")),
param = factor(substr(method.param, 4, 4)),
B.true = B[param])
# check for simulations with errors
sim.out.long %>%
filter(param == 1) %>%
group_by(q, n, x.shape, c.shape, method) %>%
summarize(prop.error = mean(is.na(estimate))) %>%
filter(prop.error > 0) %>%
kable(digits = 3) %>%
kable_styling("striped")
# extract simulation parameters
q <- unique(sim.out$q)
n <- unique(sim.out$n)
x.shape <- unique(sim.out$x.shape)
c.shape <- unique(sim.out$c.shape)
mx <- unique(sim.out$mx)
mc <- unique(sim.out$mc)
my <- unique(sim.out$my)
n.rep <- nrow(sim.out) /
n_distinct(dplyr::select(sim.out, q, n, x.shape, c.shape, mx, mc, my))
# make labels for plots
method.labs <- c("Oracle",
"Complete Case",
"Parametric MLE",
"Semiparametric")
names(method.labs) <- c("or", "cc", "ml", "sp")
q.labs <- paste0("q = ", q)
names(q.labs) <- q
n.labs <- paste0("n = ", n)
names(n.labs) <- n
shapex.labs <- c("X Correct", "X Incorrect")
names(shapex.labs) <- x.shape
shapec.labs <- c("C Correct", "C Incorrect")
names(shapec.labs) <- c.shape
mx.labs <- paste0("mx = ", mx)
names(mx.labs) <- mx
mc.labs <- paste0("mc = ", mc)
names(mc.labs) <- mc
my.labs <- paste0("my = ", my)
names(my.labs) <- my
param.labs <- c("\u03B20", "\u03B21", "log\u03C3\u00B2")
# colorblind friendly pallette
#pal_light <- cbbPalette <- c('#BBBBBB', '#228833', '#4477AA', '#AA3377')
#pal_dark <- cbbPalette <- c('#5d5d5d', '#114419', '#223b55', '#55193b')
pal_light <- c('#EE6677', '#228833', '#4477AA', '#CCBB44', '#66CCEE', '#AA3377', '#BBBBBB')
pal_dark <- c('#991122', '#114419', '#223b55', '#6b611d', '#117799', '#55193b', '#5d5d5d')
# boxplot of simulated estimates
make.est.plot <- function(param., n. = 10000, est_cutoff = Inf) {
# data for plot
plot.dat <- sim.out.long %>%
filter(param == param.,
n == n.) %>%
mutate(remove = abs(estimate - B.true) > est_cutoff,
lab.y = 0.5*(B.true - est_cutoff))
# count removed observations
remove.dat <- plot.dat %>%
group_by(q, method, x.shape, c.shape, lab.y, B.true) %>%
summarise(n.remove = sum(remove, na.rm = T)) %>%
mutate(label = ifelse(n.remove > 0,
paste0(n.remove, "\n",
method.labs[method],
"\npoints outside\nrange"), ""),
lab.y = ifelse(n.remove > 0, lab.y, B.true))
# create plot
plot.dat %>%
filter(remove == F) %>%
ggplot(aes(y = estimate,
color = method,
fill = method)) +
geom_boxplot() +
geom_text(data = remove.dat,
aes(x = -0.15, y = lab.y, label = label),
size = 2, color = "black") +
geom_hline(aes(yintercept = B.true),
linetype = "dashed",
linewidth = 0.6,
color = pal_light[4]) +
facet_nested(q ~ x.shape + c.shape,
scales = "free",
labeller = labeller(q = q.labs,
x.shape = shapex.labs,
c.shape = shapec.labs)) +
labs(y = "Parameter Estimate",
fill = "Method",
color = "Method") +
ggtitle(paste0("Empirical Distribution of Parameter Estimates for ",
param.labs[param.]),
subtitle = paste0("sample size n = ", n., "; ",
"mx = ", mx, "; ",
"mc = ", mc, "; ",
"my = ", my, "; ",
n.rep, " replicates per setting")) +
theme_bw() +
theme(axis.ticks.x = element_blank(),
axis.text.x = element_blank(),
axis.title.x = element_blank()) +
scale_fill_manual(values = pal_light[c(1, 2, 3, 6)],
labels = method.labs) +
scale_color_manual(values = pal_dark[c(1, 2, 3, 6)],
labels = method.labs)
}
make.est.plot(param. = 1, n. = 10000)
make.est.plot(param. = 2, n. = 10000)
make.est.plot(param. = 3, n. = 10000)
make.est.plot(param. = 1, n. = 10000) + ylim(0.9, 1.2)
make.est.plot(param. = 2, n. = 10000) + ylim(0, 4)
make.est.plot(param. = 3, n. = 10000) + ylim(0, 0.2)
